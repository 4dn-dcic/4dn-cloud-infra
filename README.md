# 4dn-cloud-infra
Cloud Formation templates for 4dn-dcic AWS environments

## Setup

```
pyenv install 3.6.10
# Builds or rebuilds the env, version found in `.python-version`
pyenv exec python -m venv --clear venv
. venv/bin/activate
pip install --upgrade pip
pip install --upgrade poetry
poetry install
```

## Usage

Validate Legacy Configuration:
    
    make legacy

Validate Alpha Configuration:

    make alpha

To lint a template:

    cfn-lint path/to/template

To get help:

    ./4dn-cloud-infra -h


## Documentation

["Cloud Infrastructure: Development & Deployment"](https://hms-dbmi.atlassian.net/wiki/spaces/FOURDNDCIC/pages/1929314305/Cloud+Infrastructure+Development+Deployment) on Confluence

## Architecture

* `src/secrets.py` - .gitignore'd file that contains required customization options, see Customization below
* `src/cli.py` - Command-line interface for the `4dn-cloud-infra` script
* `src/part.py` - Contains C4Part, an abstraction for building an AWS resource
* `src/stack.py` - Contains C4Stack, an abstraction for building a CloudFormation Stack
* `src/exports.py` - Contains C4Exports, an abstraction for defining export values from stacks
* `src/exceptions.py` - Exception handling for the package
* `src/info/` - Contains scripts for getting info from AWS
* `src/parts/` - Contains definitions of resources associated with each part (network, datastore etc)
* `src/stacks/` - Contains files that define the stacks (using resources from `src/parts/`)


## Customization

To customize the deployment of CGAP, you need to create a JSON secret in AWS SecretsManager, ideally given
the name of the environment you'd like to create (cgap-mastertest for example). The below values at a minimum 
must be present.

    # Required props for deployment
    deploying_iam_user = "the admin IAM user who is orchestrating the infrastructure"
    Auth0Client = "Get from Auth0"
    Auth0Secret = "Get from Auth0"
    ENV_NAME = "desired env_name, for example: cgap-mastertest"
    ENCODED_BS_ENV = "same as above"
    ENCODED_DATA_SET = "specifies load_data behavior: one of 'prod', 'test'"
    ENCODED_ES_SERVER = "XXX: output from datastore"
    ENCODED_SECRET = "Unused?"
    ENCODED_VERSION = "Should get picked up from application version"
    ENCODED_FILES_BUCKET = name_of_files_bucket, for example application-cgap-mastertest-files
    ENCODED_WFOUT_BUCKET = name_of_wfout_bucket, for example application-cgap-mastertest-wfout
    ENCODED_BLOBS_BUCKET = name_of_blobs_bucket, for example application-cgap-mastertest-blobs,
    ENCODED_SYSTEM_BUCKET = name_of_system_bucket, for example application-cgap-mastertest-system
    ENCODED_METADATA_BUNDLE_BUCKET = name_of_metadata_bundle_bucket, for example application-cgap-mastertest-metadata-bundles
    LANG = "en_US.UTF-8"
    LC_ALL = "en_US.UTF-8"
    RDS_HOSTNAME = "XXX: output from datastore"
    RDS_DB_NAME = "XXX: output from datastore"
    RDS_PORT = "XXX: output from datastore"
    RDS_USERNAME = "XXX: output from datastore"
    RDS_PASSWORD = "generated by cloudformation in secrets manager"
    S3_ENCRYPT_KEY = "regen this for every orchestrartion"
    SENTRY_DSN = "add if you want sentry"
    reCaptchaSecret = "for reCaptcha in production"

TODO: customize other stacks (RDS, ES size)
