# 4dn-cloud-infra
Cloud Formation templates for 4dn-dcic AWS environments

## Setup

```
pyenv install 3.6.10
# Builds or rebuilds the env, version found in `.python-version`
pyenv exec python -m venv --clear venv
. venv/bin/activate
pip install --upgrade pip
pip install --upgrade poetry
poetry install
```

## Usage

Validate Legacy Configuration:
    
    make legacy

Validate Alpha Configuration:

    make alpha

To lint a template:

    cfn-lint path/to/template

To get help:

    ./4dn-cloud-infra -h


## Documentation

["Cloud Infrastructure: Development & Deployment"](https://hms-dbmi.atlassian.net/wiki/spaces/FOURDNDCIC/pages/1929314305/Cloud+Infrastructure+Development+Deployment) on Confluence

## Architecture

* `src/secrets.py` - .gitignore'd file that contains required customization options, see Customization below
* `src/cli.py` - Command-line interface for the `4dn-cloud-infra` script
* `src/part.py` - Contains C4Part, an abstraction for building an AWS resource
* `src/stack.py` - Contains C4Stack, an abstraction for building a CloudFormation Stack
* `src/exports.py` - Contains C4Exports, an abstraction for defining export values from stacks
* `src/exceptions.py` - Exception handling for the package
* `src/info/` - Contains scripts for getting info from AWS
* `src/parts/` - Contains definitions of resources associated with each part (network, datastore etc)
* `src/stacks/` - Contains files that define the stacks (using resources from `src/parts/`)


## Customization

To customize the deployment of CGAP, you need to write a Python file in `src/` called `secrets.py`. This
file will contain secrets - take care not to leak this file. The relevant properties are described below.

    # Required props for deployment
    deploying_iam_user = "the admin IAM user who is orchestrating the infrastructure"
    Auth0Client = "Get from Auth0"
    Auth0Secret = "Get from Auth0"
    ENV_NAME = "desired env_name, for example: cgap-mastertest"
    ENCODED_BS_ENV = "same as above"
    ENCODED_DATA_SET = "specifies load_data behavior: one of 'prod', 'test'"
    ENCODED_ES_SERVER = "XXX: output from datastore"
    ENCODED_SECRET = "Unused?"
    ENCODED_VERSION = "Should get picked up from application version"
    LANG = "en_US.UTF-8"
    LC_ALL = "en_US.UTF-8"
    RDS_HOSTNAME = "XXX: output from datastore"
    RDS_DB_NAME = "XXX: output from datastore"
    RDS_PORT = "XXX: output from datastore"
    RDS_USERNAME = "XXX: output from datastore"
    RDS_PASSWORD = "generated by cloudformation in secrets manager"
    S3_ENCRYPT_KEY = "regen this for every orchestrartion"
    SENTRY_DSN = "add if you want sentry"
    reCaptchaSecret = "for reCaptcha in production"

    # Customization Options (unused for now, needs refactoring so they are used)
    # TO BE EXPANDED MORE
    RDS_INSTANCE_SIZE = 'db.t3.medium'
    RDS_AZ = 'us-east-1a'
    RDS_STORAGE_SIZE = 20
    
    # Prod ES Configuration
    ES_DATA_NODE_COUNT = 2
    ES_DATA_NODE_SIZE = 'r5.2xlarge.elasticsearch'
    ES_MASTER_NODE_COUNT = 3
    ES_MASTER_NODE_TYPE = 'c5.large.elasticsearch'
